name: Android Kernel Driver Builder (Custom Kernel / Single Module / Auto Toolchain)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename (e.g., munch)"
        required: true
        default: "munch"
      include_ksu:
        description: "Include KSU"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      driver_name:
        description: "Single module base name (NO .ko). Example: mydriver"
        required: true
        default: "mydriver"
      kernel_repo:
        description: "Kernel source repo"
        required: true
        default: "https://github.com/NKR00711/kernel_xiaomi_sm8250_mod"
      kernel_branch:
        description: "Kernel branch (empty = default)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: Checkout module repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          set -eux
          sudo apt update
          sudo apt install -y \
            build-essential git curl wget bison flex zip bc cpio libssl-dev \
            ccache python-is-python3 tar rsync libelf-dev \
            llvm lld \
            gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi

      - name: Setup zyc-clang toolchain
        run: |
          set -eux
          mkdir -p "$HOME/zyc-clang"
          cd "$HOME/zyc-clang"
          wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
          tar -zxf Clang-15.0.7-20251111.tar.gz
          echo "$HOME/zyc-clang/bin" >> $GITHUB_PATH

      - name: Prepare single-module sources (force one .ko)
        run: |
          set -eux
          rm -rf kerneldriver
          mkdir -p kerneldriver
          rsync -av --delete code/ kerneldriver/

          # Ensure these exist (adjust if your filenames differ)
          test -f kerneldriver/memory.c
          test -f kerneldriver/process.c
          test -f kerneldriver/entry.c

          # Force one output module: <driver_name>.ko
          cat > kerneldriver/Makefile <<'EOF'
          obj-m += __MOD__.o
          __MOD__-y := memory.o process.o entry.o
          EOF
          sed -i "s/__MOD__/${{ github.event.inputs.driver_name }}/g" kerneldriver/Makefile

          echo "=== kerneldriver/Makefile ==="
          cat kerneldriver/Makefile

      - name: Clone custom kernel source
        run: |
          set -eux
          rm -rf android-kernel
          if [ -n "${{ github.event.inputs.kernel_branch }}" ]; then
            git clone --depth=1 -b "${{ github.event.inputs.kernel_branch }}" "${{ github.event.inputs.kernel_repo }}" android-kernel
          else
            git clone --depth=1 "${{ github.event.inputs.kernel_repo }}" android-kernel
          fi

      - name: Build kernel (capture log)
        run: |
          set -eux
          cd android-kernel

          export PATH="$HOME/zyc-clang/bin:$PATH"

          if [ "${{ github.event.inputs.include_ksu }}" = "true" ]; then
            bash build.sh "${{ github.event.inputs.device }}" ksu 2>&1 | tee "$GITHUB_WORKSPACE/build_kernel.log"
          else
            bash build.sh "${{ github.event.inputs.device }}" 2>&1 | tee "$GITHUB_WORKSPACE/build_kernel.log"
          fi

      - name: Auto-detect toolchain prefixes from build log
        run: |
          set -eux

          LOG="$GITHUB_WORKSPACE/build_kernel.log"
          test -f "$LOG"

          # Try to find explicit exports like:
          # export CROSS_COMPILE=...
          # CROSS_COMPILE=...
          # make ... CROSS_COMPILE=...
          CC_PREFIX="$(grep -Eo 'CROSS_COMPILE=([A-Za-z0-9_./+-]+-)' "$LOG" | head -n1 | cut -d= -f2 || true)"
          CC32_PREFIX="$(grep -Eo 'CROSS_COMPILE_ARM32=([A-Za-z0-9_./+-]+-)' "$LOG" | head -n1 | cut -d= -f2 || true)"
          CLANG_TRIPLE="$(grep -Eo 'CLANG_TRIPLE=([A-Za-z0-9_./+-]+-)' "$LOG" | head -n1 | cut -d= -f2 || true)"

          # If not found, try to infer from common patterns in printed commands
          # e.g. "aarch64-linux-android-gcc", "aarch64-linux-gnu-gcc"
          if [ -z "$CC_PREFIX" ]; then
            CC_PREFIX="$(grep -Eo '([A-Za-z0-9_./+-]*aarch64[A-Za-z0-9_./+-]*-)(gcc|ld|as)\b' "$LOG" | head -n1 | sed -E 's/(gcc|ld|as)$//' || true)"
          fi
          if [ -z "$CC32_PREFIX" ]; then
            CC32_PREFIX="$(grep -Eo '([A-Za-z0-9_./+-]*arm[A-Za-z0-9_./+-]*-)(gcc|ld|as)\b' "$LOG" | head -n1 | sed -E 's/(gcc|ld|as)$//' || true)"
          fi

          # Fallbacks (safe on GH runners because we apt-installed these)
          : "${CC_PREFIX:=aarch64-linux-gnu-}"
          : "${CC32_PREFIX:=arm-linux-gnueabi-}"
          : "${CLANG_TRIPLE:=$CC_PREFIX}"

          echo "Detected CROSS_COMPILE=$CC_PREFIX"
          echo "Detected CROSS_COMPILE_ARM32=$CC32_PREFIX"
          echo "Detected CLANG_TRIPLE=$CLANG_TRIPLE"

          {
            echo "CROSS_COMPILE=$CC_PREFIX"
            echo "CROSS_COMPILE_ARM32=$CC32_PREFIX"
            echo "CLANG_TRIPLE=$CLANG_TRIPLE"
          } >> $GITHUB_ENV

      - name: modules_prepare (non-interactive, using detected prefixes)
        run: |
          set -eux
          cd android-kernel

          export PATH="$HOME/zyc-clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64

          export CC=clang
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip

          echo "Using CROSS_COMPILE=$CROSS_COMPILE"
          echo "Using CROSS_COMPILE_ARM32=$CROSS_COMPILE_ARM32"
          echo "Using CLANG_TRIPLE=$CLANG_TRIPLE"

          yes "" | make O=out olddefconfig
          make O=out modules_prepare

      - name: Build the single module (.ko)
        run: |
          set -eux
          cd android-kernel

          export PATH="$HOME/zyc-clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64

          export CC=clang
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip

          make O=out M="${GITHUB_WORKSPACE}/kerneldriver" modules -j"$(nproc)"

          ls -lah "${GITHUB_WORKSPACE}/kerneldriver/${{ github.event.inputs.driver_name }}.ko"

      - name: Upload module artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.device }}-${{ github.event.inputs.driver_name }}.ko
          path: kerneldriver/${{ github.event.inputs.driver_name }}.ko
