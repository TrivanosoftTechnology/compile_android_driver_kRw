name: Android Kernel Driver Builder (Custom Kernel / Single Module)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename (e.g., munch)"
        required: true
        default: "munch"
      include_ksu:
        description: "Include KSU"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      driver_name:
        description: "Single module base name (NO .ko). Example: mydriver"
        required: true
        default: "mydriver"
      kernel_repo:
        description: "Kernel source repo"
        required: true
        default: "https://github.com/NKR00711/kernel_xiaomi_sm8250_mod"
      kernel_branch:
        description: "Kernel branch (empty = default)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: Checkout module repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          set -eux
          sudo apt update
          sudo apt install -y \
            build-essential git curl wget bison flex zip bc cpio libssl-dev \
            ccache python-is-python3 tar rsync libelf-dev \
            llvm lld

      - name: Setup zyc-clang toolchain
        run: |
          set -eux
          mkdir -p "$HOME/zyc-clang"
          cd "$HOME/zyc-clang"
          wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
          tar -zxf Clang-15.0.7-20251111.tar.gz
          echo "$HOME/zyc-clang/bin" >> $GITHUB_PATH

      - name: Prepare single-module sources (force one .ko)
        run: |
          set -eux
          rm -rf kerneldriver
          mkdir -p kerneldriver
          rsync -av --delete code/ kerneldriver/

          # Ensure the 3 source files exist
          test -f kerneldriver/memory.c
          test -f kerneldriver/process.c
          test -f kerneldriver/entry.c

          # Force one output module: <driver_name>.ko
          cat > kerneldriver/Makefile <<'EOF'
          obj-m += __MOD__.o
          __MOD__-y := memory.o process.o entry.o
          EOF
          sed -i "s/__MOD__/${{ github.event.inputs.driver_name }}/g" kerneldriver/Makefile

          echo "=== kerneldriver/Makefile ==="
          cat kerneldriver/Makefile

      - name: Clone custom kernel source
        run: |
          set -eux
          rm -rf android-kernel
          if [ -n "${{ github.event.inputs.kernel_branch }}" ]; then
            git clone --depth=1 -b "${{ github.event.inputs.kernel_branch }}" "${{ github.event.inputs.kernel_repo }}" android-kernel
          else
            git clone --depth=1 "${{ github.event.inputs.kernel_repo }}" android-kernel
          fi

      - name: Build kernel (generates out/)
        run: |
          set -eux
          cd android-kernel
          if [ "${{ github.event.inputs.include_ksu }}" = "true" ]; then
            bash build.sh "${{ github.event.inputs.device }}" ksu
          else
            bash build.sh "${{ github.event.inputs.device }}"
          fi

      - name: Prepare kernel for external modules (fix arm64 clang target + non-interactive config)
        run: |
          set -eux
          cd android-kernel

          export PATH="$HOME/zyc-clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip

          # Critical: ensure clang targets arm64 so w0/x1 asm registers are recognized
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

          # Avoid interactive Kconfig prompts in CI
          yes "" | make O=out olddefconfig

          make O=out modules_prepare

      - name: Build the single module (.ko)
        run: |
          set -eux
          cd android-kernel

          export PATH="$HOME/zyc-clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CC=clang
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

          make O=out M="${GITHUB_WORKSPACE}/kerneldriver" modules -j"$(nproc)"

          # Verify the expected single .ko exists
          ls -lah "${GITHUB_WORKSPACE}/kerneldriver/${{ github.event.inputs.driver_name }}.ko"

      - name: Upload module artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.device }}-${{ github.event.inputs.driver_name }}.ko
          path: kerneldriver/${{ github.event.inputs.driver_name }}.ko
