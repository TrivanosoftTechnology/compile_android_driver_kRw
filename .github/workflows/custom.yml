name: Android Kernel Driver Builder (Custom Kernel / Single Module)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename (e.g., munch)"
        required: true
        default: "munch"
      include_ksu:
        description: "Include KSU"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      driver_name:
        description: "Single module base name (NO .ko). Example: kerneldriver"
        required: true
        default: "kerneldriver"
      kernel_repo:
        description: "Kernel source repo"
        required: true
        default: "https://github.com/NKR00711/kernel_xiaomi_sm8250_mod"
      kernel_branch:
        description: "Kernel branch (empty = default)"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: Checkout module repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          set -eux
          sudo apt update
          sudo apt install -y \
            build-essential git curl wget bison flex zip bc cpio libssl-dev \
            ccache python-is-python3 tar rsync libelf-dev \
            clang llvm lld

      - name: Setup zyc-clang toolchain
        run: |
          set -eux
          mkdir -p "$HOME/zyc-clang"
          cd "$HOME/zyc-clang"
          wget -q https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz
          tar -zxf Clang-15.0.7-20251111.tar.gz
          echo "$HOME/zyc-clang/bin" >> $GITHUB_PATH

      - name: Prepare module sources and force single-module Makefile
        run: |
          set -eux
          rm -rf kerneldriver
          mkdir -p kerneldriver
          rsync -av --delete code/ kerneldriver/

          # Force a single-module Makefile using driver_name
          # This produces: <driver_name>.ko built from memory.c process.c entry.c
          cat > kerneldriver/Makefile <<'EOF'
          obj-m += __MOD__.o
          __MOD__-y := memory.o process.o entry.o
          EOF
          sed -i "s/__MOD__/${{ github.event.inputs.driver_name }}/g" kerneldriver/Makefile

          echo "=== kerneldriver/Makefile ==="
          cat kerneldriver/Makefile

      - name: Clone custom kernel source
        run: |
          set -eux
          rm -rf android-kernel
          if [ -n "${{ github.event.inputs.kernel_branch }}" ]; then
            git clone --depth=1 -b "${{ github.event.inputs.kernel_branch }}" "${{ github.event.inputs.kernel_repo }}" android-kernel
          else
            git clone --depth=1 "${{ github.event.inputs.kernel_repo }}" android-kernel
          fi

      - name: Build kernel (generates out/)
        run: |
          set -eux
          cd android-kernel
          if [ "${{ github.event.inputs.include_ksu }}" = "true" ]; then
            bash build.sh "${{ github.event.inputs.device }}" ksu
          else
            bash build.sh "${{ github.event.inputs.device }}"
          fi

      - name: modules_prepare
        run: |
          set -eux
          cd android-kernel
          export PATH="$HOME/zyc-clang/bin:$PATH"
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          make O=out modules_prepare

      - name: Build module
        run: |
          set -eux
          cd android-kernel
          export PATH="$HOME/zyc-clang/bin:$PATH"
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1

          make O=out M="${GITHUB_WORKSPACE}/kerneldriver" modules -j"$(nproc)"

          ls -lah "${GITHUB_WORKSPACE}/kerneldriver/${{ github.event.inputs.driver_name }}.ko"

      - name: Upload module artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.device }}-${{ github.event.inputs.driver_name }}.ko
          path: |
            kerneldriver/${{ github.event.inputs.driver_name }}.ko
